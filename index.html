<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeFinder - Discover Your Next Favorite Anime</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style type="text/tailwindcss">
        @theme {
            --color-primary: #6366f1;
            --color-secondary: #ec4899;
            --color-dark: #0f172a;
            --color-surface: #1e293b;
            --font-sans: 'Outfit', sans-serif;
        }
        
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(236, 72, 153, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .glass-card:hover {
            background: rgba(30, 41, 59, 0.8);
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.3);
            transform: translateY(-5px);
        }

        /* Card Animations */
        .anime-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Marquee Animation */
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-33.33%); } /* Shifted to 1/3 because we tripled content */
        }
        @keyframes marquee-reverse {
            0% { transform: translateX(-33.33%); }
            100% { transform: translateX(0); }
        }
        .marquee-container {
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        .marquee-content {
            display: flex;
            width: max-content;
            animation: marquee 45s linear infinite;
        }
        .marquee-content.reverse {
            animation: marquee-reverse 50s linear infinite;
        }
        .marquee-content:hover {
            animation-play-state: paused;
        }

        /* Loader */
        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #FFF;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .loader::after {
            content: '';  
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid;
            border-color: #6366f1 transparent;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Fade In & Scale */
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(10px);
        }
        @keyframes fadeIn {
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stagger-1 { animation-delay: 100ms; }
        .stagger-2 { animation-delay: 200ms; }
        .stagger-3 { animation-delay: 300ms; }
        .stagger-4 { animation-delay: 400ms; }

        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Input Reset */
        input, select {
            appearance: none;
            -webkit-appearance: none;
        }
        
        /* Selection */
        ::selection {
            background: #6366f1;
            color: white;
        }
    </style>
</head>
<body class="text-slate-200 min-h-screen overflow-x-hidden">

    <!-- Navigation -->
    <nav class="fixed w-full z-50 top-0 transition-all duration-300 glass border-b-0">
        <div class="container mx-auto px-4 md:px-6 py-4 flex justify-between items-center">
            <a href="#" onclick="navigate('home')" class="flex items-center gap-2 group">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-pink-500 flex items-center justify-center text-white font-bold shadow-lg group-hover:scale-110 transition-transform">AF</div>
                <span class="text-xl font-bold tracking-tight text-white group-hover:text-indigo-300 transition-colors">AnimeFinder</span>
            </a>
            
            <div class="hidden md:flex items-center space-x-1 bg-slate-800/50 p-1 rounded-full border border-slate-700/50 backdrop-blur-sm">
                <button onclick="navigate('home')" id="nav-home" class="nav-btn px-5 py-2 rounded-full text-sm font-medium transition-all hover:text-white text-slate-400">Home</button>
                <button onclick="navigate('quiz')" id="nav-quiz" class="nav-btn px-5 py-2 rounded-full text-sm font-medium transition-all hover:text-white text-slate-400">Quiz</button>
                <button onclick="navigate('browse')" id="nav-browse" class="nav-btn px-5 py-2 rounded-full text-sm font-medium transition-all hover:text-white text-slate-400">Browse</button>
                <button onclick="navigate('schedule')" id="nav-schedule" class="nav-btn px-5 py-2 rounded-full text-sm font-medium transition-all hover:text-white text-slate-400">Schedule</button>
            </div>

            <div class="hidden md:flex items-center gap-3">
                <button onclick="surpriseMe()" class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 text-white rounded-lg text-sm font-semibold shadow-lg shadow-indigo-500/20 transition-all hover:-translate-y-0.5 active:translate-y-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                    </svg>
                    Surprise Me
                </button>
            </div>

            <button class="md:hidden text-slate-300 p-2 rounded-lg hover:bg-slate-800" onclick="toggleMobileMenu()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>
        
        <div id="mobile-menu" class="hidden md:hidden absolute top-full left-0 w-full bg-slate-900/95 border-b border-slate-800 p-4 space-y-2 shadow-2xl backdrop-blur-xl">
            <button onclick="navigate('home'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 font-medium">Home</button>
            <button onclick="navigate('quiz'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 font-medium">Quiz</button>
            <button onclick="navigate('browse'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 font-medium">Browse</button>
            <button onclick="navigate('schedule'); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-xl hover:bg-slate-800 font-medium">Schedule</button>
            <button onclick="surpriseMe(); toggleMobileMenu()" class="block w-full text-left px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-600/20 to-pink-600/20 text-pink-400 font-medium border border-pink-500/30 mt-2">Surprise Me</button>
        </div>
    </nav>

    <main id="app" class="pt-24 container mx-auto px-4 md:px-6 pb-12 min-h-screen transition-all">
        <!-- Content injected via JS -->
    </main>

    <footer class="glass mt-auto border-t border-slate-800">
        <div class="container mx-auto px-6 py-12">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                <div class="space-y-4">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-pink-500 flex items-center justify-center text-white font-bold shadow-lg">AF</div>
                        <span class="text-xl font-bold text-white">AnimeFinder</span>
                    </div>
                    <p class="text-slate-400 text-sm leading-relaxed">
                        Your ultimate destination for discovering anime. Powered by the AniList API, we help you find your next obsession in seconds.
                    </p>
                    <div class="flex gap-4">
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/></svg></a>
                        <a href="#" class="text-slate-400 hover:text-indigo-400 transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-white font-bold mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-sm text-slate-400">
                        <li><button onclick="navigate('home')" class="hover:text-indigo-400 transition">Home</button></li>
                        <li><button onclick="navigate('quiz')" class="hover:text-indigo-400 transition">Recommendation Quiz</button></li>
                        <li><button onclick="navigate('browse')" class="hover:text-indigo-400 transition">Browse Collection</button></li>
                        <li><button onclick="navigate('schedule')" class="hover:text-indigo-400 transition">Airing Schedule</button></li>
                        <li><button onclick="surpriseMe()" class="hover:text-pink-400 transition">Surprise Me!</button></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="text-white font-bold mb-4">Legal & Credits</h3>
                    <ul class="space-y-2 text-sm text-slate-400">
                        <li>Data provided by <a href="https://anilist.co/" target="_blank" class="text-indigo-400 hover:underline">AniList API</a></li>
                        <li>Images are property of their owners</li>
                        <li><a href="#" class="hover:text-white transition">Privacy Policy</a></li>
                        <li><a href="#" class="hover:text-white transition">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="border-t border-slate-800 mt-10 pt-6 text-center text-slate-500 text-xs">
                &copy; 2025 AnimeFinder. Made with ‚ù§Ô∏è by AKI for the anime community.
            </div>
        </div>
    </footer>

    <!-- Main Modal -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        <div id="modal-content" class="bg-slate-900 rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto shadow-2xl border border-slate-700 transform scale-95 transition-all duration-300 shadow-indigo-500/10">
        </div>
    </div>

    <!-- Character Modal (Nested) -->
    <div id="character-modal-overlay" class="hidden"></div>

    <!-- Settings Modal -->
    <div id="surprise-settings-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-md z-50 hidden flex items-center justify-center p-4 opacity-0 transition-all duration-300">
        <div id="surprise-settings-content" class="bg-slate-900 rounded-2xl max-w-md w-full shadow-2xl border border-slate-700 transform scale-95 transition-all duration-300">
        </div>
    </div>

    <script>
        const ANILIST_API = 'https://graphql.anilist.co';
        
        const state = {
            currentPage: 'home',
            schedule: { selectedDate: null },
            quiz: { currentStep: 0, answers: [] },
            browse: {
                page: 1,
                search: '',
                genre: '',
                format: '',
                status: '',
                sort: 'POPULARITY_DESC',
                minScore: '',
                year: ''
            },
            surprise: {
                genre: '',
                format: '',
                minScore: '70',
                year: ''
            },
            genres: ['Action', 'Adventure', 'Comedy', 'Drama', 'Ecchi', 'Fantasy', 'Horror', 'Mahou Shoujo', 'Mecha', 'Music', 'Mystery', 'Psychological', 'Romance', 'Sci-Fi', 'Slice of Life', 'Sports', 'Supernatural', 'Thriller']
        };

        // -- Utility Functions --

        function updateActiveNav() {
            ['home', 'quiz', 'browse', 'schedule'].forEach(page => {
                const btn = document.getElementById(`nav-${page}`);
                if (!btn) return;
                
                if (state.currentPage === page) {
                    btn.classList.remove('text-slate-400', 'hover:text-white');
                    btn.classList.add('bg-slate-700', 'text-white', 'shadow-sm');
                } else {
                    btn.classList.add('text-slate-400', 'hover:text-white');
                    btn.classList.remove('bg-slate-700', 'text-white', 'shadow-sm');
                }
            });
        }

        async function anilistQuery(query, variables = {}) {
            try {
                const response = await fetch(ANILIST_API, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({ query, variables })
                });
                const data = await response.json();
                if (!response.ok) throw new Error('Network response was not ok');
                return data.data;
            } catch (error) {
                console.error('API Error:', error);
                return null;
            }
        }

        function getLoaderHtml() {
            return '<div class="col-span-full flex justify-center py-20 items-center flex-col gap-4"><span class="loader"></span><span class="text-slate-500 text-sm font-medium animate-pulse">Fetching Anime...</span></div>';
        }

        function formatDate(dateObj) {
            if (!dateObj || !dateObj.year) return 'Unknown';
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            if (dateObj.month) {
                return `${months[dateObj.month - 1]} ${dateObj.year}`;
            }
            return dateObj.year;
        }

        // -- View Templates --

        const views = {
            home: () => `
                <div class="flex flex-col items-center justify-center min-h-[70vh] text-center fade-in relative">
                    <!-- Decorative Elements -->
                    <div class="absolute top-10 left-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl"></div>
                    <div class="absolute bottom-10 right-10 w-40 h-40 bg-pink-500/20 rounded-full blur-3xl"></div>

                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800/50 border border-slate-700 text-xs font-medium text-indigo-400 mb-6 stagger-1">
                        <span class="relative flex h-2 w-2">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                        </span>
                        Discover thousands of anime
                    </div>
                    
                    <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight leading-tight stagger-2">
                        Find Your Next <br />
                        <span class="text-gradient">Anime Obsession</span>
                    </h1>
                    
                    <p class="text-lg text-slate-400 mb-10 max-w-2xl leading-relaxed stagger-3">
                        Stop scrolling endlessly. Whether you know exactly what you want or need a little inspiration, we've got the perfect show for you.
                    </p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-5 w-full max-w-5xl stagger-4">
                        <button onclick="navigate('quiz')" class="group relative glass-card rounded-2xl p-8 text-left transition-all overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <svg class="w-24 h-24 text-indigo-400" fill="currentColor" viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z"/></svg>
                            </div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-indigo-500/20 flex items-center justify-center mb-4 text-indigo-400 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                                </div>
                                <h3 class="text-xl font-bold mb-2 text-white">Take the Quiz</h3>
                                <p class="text-slate-400 text-sm">Answer 5 questions to get a personalized recommendation instantly.</p>
                            </div>
                        </button>

                        <button onclick="navigate('browse')" class="group relative glass-card rounded-2xl p-8 text-left transition-all overflow-hidden">
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <svg class="w-24 h-24 text-pink-400" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                            </div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-pink-500/20 flex items-center justify-center mb-4 text-pink-400 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </div>
                                <h3 class="text-xl font-bold mb-2 text-white">Browse Collection</h3>
                                <p class="text-slate-400 text-sm">Filter by genre, year, score, and more to find hidden gems.</p>
                            </div>
                        </button>

                        <div class="group relative glass-card rounded-2xl p-8 text-left transition-all overflow-hidden cursor-pointer" onclick="surpriseMe()">
                            <div class="absolute top-3 right-3 z-20">
                                <button onclick="event.stopPropagation(); openSurpriseSettings()" class="p-2 rounded-full hover:bg-slate-700/50 text-slate-400 hover:text-white transition-colors" title="Settings">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                </button>
                            </div>
                            <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                <svg class="w-24 h-24 text-purple-400" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM7.5 18c-.83 0-1.5-.67-1.5-1.5S6.67 15 7.5 15s1.5.67 1.5 1.5S8.33 18 7.5 18zm0-9C6.67 9 6 8.33 6 7.5S6.67 6 7.5 6 9 6.67 9 7.5 8.33 9 7.5 9zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm4.5 4.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm0-9c-.83 0-1.5-.67-1.5-1.5S15.67 6 16.5 6s1.5.67 1.5 1.5S17.33 9 16.5 9z"/></svg>
                            </div>
                            <div class="relative z-10">
                                <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mb-4 text-purple-400 group-hover:scale-110 transition-transform">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                </div>
                                <h3 class="text-xl font-bold mb-2 text-white">Surprise Me</h3>
                                <p class="text-slate-400 text-sm">Feeling lucky? Let the universe decide your next watch.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-12 space-y-12 stagger-4 fade-in pb-12">
                    
                    <!-- Upcoming Marquee -->
                    <div class="w-full overflow-hidden">
                        <h2 class="text-2xl font-bold flex items-center gap-2 mb-6 px-2">
                            <span class="w-1 h-6 bg-pink-500 rounded-full"></span>
                            Upcoming Hype
                        </h2>
                        <div class="marquee-container w-full overflow-hidden">
                            <div id="upcoming-container" class="marquee-content gap-6 py-4 pl-4">
                                ${getLoaderHtml()}
                            </div>
                        </div>
                    </div>

                    <!-- Critically Acclaimed Marquee (Reverse) -->
                    <div class="w-full overflow-hidden">
                        <h2 class="text-2xl font-bold flex items-center gap-2 mb-6 px-2">
                            <span class="w-1 h-6 bg-yellow-500 rounded-full"></span>
                            Critically Acclaimed
                        </h2>
                        <div class="marquee-container w-full overflow-hidden">
                            <div id="top-rated-container" class="marquee-content reverse gap-6 py-4 pl-4">
                                ${getLoaderHtml()}
                            </div>
                        </div>
                    </div>

                    <!-- Trending Carousel -->
                    <div class="relative group/slider">
                        <div class="flex items-center justify-between mb-6 px-2">
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                <span class="w-1 h-6 bg-indigo-500 rounded-full"></span>
                                Trending Now
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="scrollCarousel('trending-container', -1)" class="p-2 rounded-full bg-slate-800/80 hover:bg-indigo-600 border border-slate-700 hover:border-indigo-500 transition shadow-lg backdrop-blur-sm"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                                <button onclick="scrollCarousel('trending-container', 1)" class="p-2 rounded-full bg-slate-800/80 hover:bg-indigo-600 border border-slate-700 hover:border-indigo-500 transition shadow-lg backdrop-blur-sm"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                            </div>
                        </div>
                        <div id="trending-container" class="flex gap-5 overflow-x-auto scroll-smooth no-scrollbar px-2 pb-8 snap-x">
                            ${getLoaderHtml()}
                        </div>
                    </div>

                    <!-- All Time Popular Carousel -->
                    <div class="relative group/slider">
                        <div class="flex items-center justify-between mb-6 px-2">
                            <h2 class="text-2xl font-bold flex items-center gap-2">
                                <span class="w-1 h-6 bg-purple-500 rounded-full"></span>
                                All Time Popular
                            </h2>
                            <div class="flex gap-2">
                                <button onclick="scrollCarousel('popular-container', -1)" class="p-2 rounded-full bg-slate-800/80 hover:bg-purple-600 border border-slate-700 hover:border-purple-500 transition shadow-lg backdrop-blur-sm"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg></button>
                                <button onclick="scrollCarousel('popular-container', 1)" class="p-2 rounded-full bg-slate-800/80 hover:bg-purple-600 border border-slate-700 hover:border-purple-500 transition shadow-lg backdrop-blur-sm"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg></button>
                            </div>
                        </div>
                        <div id="popular-container" class="flex gap-5 overflow-x-auto scroll-smooth no-scrollbar px-2 pb-8 snap-x">
                            ${getLoaderHtml()}
                        </div>
                    </div>
                </div>
            `,
            quiz: () => {
                const questions = [
                    {
                        id: 1,
                        text: "What are you in the mood for?",
                        options: [
                            { label: "Action & Hype", value: "Action", icon: "‚öîÔ∏è", desc: "Explosions, fights, and intensity." },
                            { label: "Good Laughs", value: "Comedy", icon: "üòÇ", desc: "Lighthearted fun and humor." },
                            { label: "Deep & Emotional", value: "Drama", icon: "üé≠", desc: "Stories that hit you in the feels." },
                            { label: "Dark & Suspenseful", value: "Mystery", icon: "üïµÔ∏è", desc: "Psychological thrillers and puzzles." }
                        ]
                    },
                    {
                        id: 2,
                        text: "Pick your preferred setting:",
                        options: [
                            { label: "Fantasy World", value: "Fantasy", icon: "üêâ", desc: "Magic, dragons, and isekai." },
                            { label: "Sci-Fi Future", value: "Sci-Fi", icon: "üöÄ", desc: "Space, mechs, and tech." },
                            { label: "Modern / School", value: "Slice of Life", icon: "üè´", desc: "Relatable everyday life." },
                            { label: "Supernatural", value: "Supernatural", icon: "üëª", desc: "Ghosts, demons, and spirits." }
                        ]
                    },
                    {
                        id: 3,
                        text: "What kind of protagonist do you like?",
                        options: [
                            { label: "Strong & Heroic", value: "Action", icon: "ü¶∏", desc: "Saves the day, never gives up." },
                            { label: "Underdog", value: "Sports", icon: "üå±", desc: "Starts weak, grows strong." },
                            { label: "Smart & Strategic", value: "Psychological", icon: "üß†", desc: "Outwits enemies with mind games." },
                            { label: "Romantic & Kind", value: "Romance", icon: "üíñ", desc: "Driven by love and relationships." }
                        ]
                    },
                    {
                        id: 4,
                        text: "How much time do you have?",
                        options: [
                            { label: "Binge a Series", value: "TV", icon: "üì∫", desc: "Give me 12+ episodes." },
                            { label: "Watch a Movie", value: "MOVIE", icon: "üé¨", desc: "Done in 2 hours." },
                            { label: "Short & Sweet", value: "OVA", icon: "‚ö°", desc: "Just a quick special." },
                            { label: "Any length", value: "any", icon: "ü§∑", desc: "I don't mind." }
                        ]
                    },
                    {
                        id: 5,
                        text: "Animation Style preference?",
                        options: [
                            { label: "Modern & Crisp", value: "modern", icon: "‚ú®", desc: "2020s high budget visuals." },
                            { label: "2010s Golden Era", value: "2010s", icon: "üåü", desc: "The standard anime look." },
                            { label: "Classic Retro", value: "classic", icon: "üìº", desc: "90s aesthetic and grain." },
                            { label: "Story over Art", value: "any", icon: "üìñ", desc: "I care about plot more." }
                        ]
                    }
                ];

                if (state.quiz.currentStep >= questions.length) {
                    return `
                        <div class="flex flex-col items-center fade-in max-w-6xl mx-auto">
                            <div class="text-center mb-10">
                                <div class="inline-block p-3 rounded-full bg-green-500/20 text-green-400 mb-4">
                                    <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                </div>
                                <h2 class="text-4xl font-bold mb-3">Your Personalized Picks</h2>
                                <p class="text-slate-400">Based on your preferences, you'll love these.</p>
                            </div>
                            
                            <div id="quiz-results" class="grid grid-cols-2 md:grid-cols-4 gap-6 w-full">
                                ${getLoaderHtml()}
                            </div>
                            
                            <button onclick="resetQuiz()" class="mt-12 px-8 py-3 bg-slate-800 hover:bg-slate-700 rounded-full transition-all border border-slate-700 text-slate-300 font-medium flex items-center gap-2 group">
                                <svg class="w-4 h-4 group-hover:-rotate-180 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Start Over
                            </button>
                        </div>
                    `;
                }

                const q = questions[state.quiz.currentStep];
                const progress = ((state.quiz.currentStep) / questions.length) * 100;

                return `
                    <div class="max-w-3xl mx-auto mt-6 fade-in">
                        <div class="mb-8">
                            <div class="flex justify-between text-xs font-bold uppercase tracking-wider text-slate-500 mb-2">
                                <span>Question ${state.quiz.currentStep + 1} / ${questions.length}</span>
                                <span>${Math.round(progress)}%</span>
                            </div>
                            <div class="w-full bg-slate-800 h-2 rounded-full overflow-hidden">
                                <div class="bg-gradient-to-r from-indigo-500 to-pink-500 h-2 rounded-full transition-all duration-500 ease-out" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        
                        <div class="glass-card p-8 md:p-10 rounded-3xl border border-slate-700/50 relative overflow-hidden">
                            <!-- Background blob -->
                            <div class="absolute -top-20 -right-20 w-60 h-60 bg-indigo-500/10 rounded-full blur-3xl pointer-events-none"></div>
                            
                            <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">${q.text}</h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${q.options.map((opt, idx) => `
                                    <button onclick="handleQuizAnswer('${opt.value}')" class="group relative flex items-center p-4 rounded-xl bg-slate-800/50 hover:bg-indigo-600/90 border border-slate-700 hover:border-indigo-500 transition-all duration-300 text-left hover:scale-[1.02] hover:shadow-xl hover:shadow-indigo-500/20 overflow-hidden" style="animation-delay: ${idx * 100}ms; animation: fadeIn 0.5s ease-out forwards; opacity: 0; transform: translateY(10px);">
                                        <span class="text-3xl mr-4 bg-slate-900/50 w-12 h-12 flex items-center justify-center rounded-lg group-hover:bg-white/20 transition-colors">${opt.icon}</span>
                                        <div class="flex-1 relative z-10">
                                            <span class="block font-bold text-lg text-slate-200 group-hover:text-white">${opt.label}</span>
                                            <span class="block text-xs text-slate-400 group-hover:text-indigo-100">${opt.desc}</span>
                                        </div>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        
                         <div class="text-center mt-6">
                            <button onclick="navigate('home')" class="text-slate-500 hover:text-slate-300 text-sm underline decoration-slate-700 hover:decoration-slate-400 underline-offset-4">Cancel Quiz</button>
                        </div>
                    </div>
                `;
            },
            browse: () => `
                <div class="fade-in space-y-6">
                    <!-- Search & Filter Bar -->
                    <div class="glass p-4 rounded-2xl border border-slate-700/50 sticky top-20 z-30 shadow-xl backdrop-blur-xl">
                        <div class="flex flex-col md:flex-row gap-4">
                            <div class="relative flex-grow group">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-5 w-5 text-slate-400 group-focus-within:text-indigo-400 transition-colors" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <input type="text" id="search-input" placeholder="Search anime..." class="block w-full pl-10 pr-10 py-3 border border-slate-600 rounded-xl leading-5 bg-slate-800/50 text-slate-300 placeholder-slate-500 focus:outline-none focus:bg-slate-800 focus:ring-2 focus:ring-indigo-500/50 focus:border-indigo-500 transition-all sm:text-sm" value="${state.browse.search}" onkeyup="debounceSearch(event)">
                                ${state.browse.search ? '<button onclick="clearSearch()" class="absolute inset-y-0 right-0 pr-3 flex items-center text-slate-500 hover:text-white"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>' : ''}
                            </div>
                            
                            <button onclick="toggleFilters()" class="flex items-center justify-center gap-2 px-6 py-3 bg-slate-800/80 hover:bg-slate-700 border border-slate-600 rounded-xl text-slate-300 hover:text-white transition-all font-medium whitespace-nowrap">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                                Filters
                                <span id="active-filters-count" class="hidden ml-1 px-2 py-0.5 bg-indigo-500 text-white text-xs font-bold rounded-full">0</span>
                            </button>
                        </div>
                        
                        <!-- Advanced Filters Panel -->
                        <div id="advanced-filters" class="hidden mt-4 pt-4 border-t border-slate-700/50 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <select id="genre-filter" onchange="handleFilterChange()" class="bg-slate-800 border border-slate-600 text-slate-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="">All Genres</option>
                                ${state.genres.map(g => `<option value="${g}" ${state.browse.genre === g ? 'selected' : ''}>${g}</option>`).join('')}
                            </select>
                            
                            <select id="format-filter" onchange="handleFilterChange()" class="bg-slate-800 border border-slate-600 text-slate-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="">All Formats</option>
                                <option value="TV" ${state.browse.format === 'TV' ? 'selected' : ''}>TV Series</option>
                                <option value="MOVIE" ${state.browse.format === 'MOVIE' ? 'selected' : ''}>Movie</option>
                                <option value="OVA" ${state.browse.format === 'OVA' ? 'selected' : ''}>OVA</option>
                                <option value="ONA" ${state.browse.format === 'ONA' ? 'selected' : ''}>ONA</option>
                            </select>
                            
                            <select id="status-filter" onchange="handleFilterChange()" class="bg-slate-800 border border-slate-600 text-slate-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="">All Status</option>
                                <option value="RELEASING" ${state.browse.status === 'RELEASING' ? 'selected' : ''}>Airing</option>
                                <option value="FINISHED" ${state.browse.status === 'FINISHED' ? 'selected' : ''}>Completed</option>
                                <option value="NOT_YET_RELEASED" ${state.browse.status === 'NOT_YET_RELEASED' ? 'selected' : ''}>Upcoming</option>
                            </select>
                            
                            <select id="score-filter" onchange="handleFilterChange()" class="bg-slate-800 border border-slate-600 text-slate-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                <option value="">Any Score</option>
                                <option value="85" ${state.browse.minScore === '85' ? 'selected' : ''}>85+ (Masterpiece)</option>
                                <option value="80" ${state.browse.minScore === '80' ? 'selected' : ''}>80+ (Great)</option>
                                <option value="70" ${state.browse.minScore === '70' ? 'selected' : ''}>70+ (Good)</option>
                            </select>
                            
                            <input type="number" id="year-filter" placeholder="Year (e.g. 2023)" min="1970" max="2025" value="${state.browse.year}" onchange="handleFilterChange()" class="bg-slate-800 border border-slate-600 text-slate-300 text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            
                            <div class="col-span-full pt-2 border-t border-slate-700/50 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div class="flex flex-wrap gap-2">
                                    <span class="text-xs text-slate-500 uppercase font-bold py-2">Sort By:</span>
                                    <button onclick="setSortOption('POPULARITY_DESC')" class="sort-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-600 ${state.browse.sort === 'POPULARITY_DESC' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">Popular</button>
                                    <button onclick="setSortOption('SCORE_DESC')" class="sort-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-600 ${state.browse.sort === 'SCORE_DESC' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">Top Rated</button>
                                    <button onclick="setSortOption('START_DATE_DESC')" class="sort-btn px-3 py-1 rounded-full text-xs font-medium border border-slate-600 ${state.browse.sort === 'START_DATE_DESC' ? 'bg-indigo-600 text-white border-indigo-500' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">Newest</button>
                                </div>
                                <button onclick="clearAllFilters()" class="text-xs text-red-400 hover:text-red-300 font-medium">Clear All Filters</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Grid -->
                    <div id="browse-results" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
                        ${getLoaderHtml()}
                    </div>
                    
                    <!-- Pagination -->
                    <div class="flex justify-center items-center mt-12 gap-4">
                        <button onclick="changePage(-1)" id="prev-page" class="w-12 h-12 flex items-center justify-center rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 hover:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <span id="page-indicator" class="text-slate-300 font-medium text-lg min-w-[80px] text-center">Page 1</span>
                        <button onclick="changePage(1)" id="next-page" class="w-12 h-12 flex items-center justify-center rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 hover:border-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed transition-all">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                </div>
            `,
            schedule: () => {
                const today = new Date();
                // Normalize today to start of day
                today.setHours(0,0,0,0);
                
                // If state has selection, use it, otherwise default to today
                let selectedDate = today;
                if (state.schedule.selectedDate) {
                    selectedDate = new Date(state.schedule.selectedDate * 1000);
                } else {
                    state.schedule.selectedDate = Math.floor(today.getTime() / 1000);
                }
                
                // Generate 7 days starting from today
                const days = [];
                for(let i = 0; i < 7; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);
                    days.push(d);
                }
                
                const selectedTimestamp = state.schedule.selectedDate;

                return `
                <div class="fade-in space-y-8">
                    <div class="text-center mb-8">
                        <h2 class="text-4xl font-bold mb-2">Airing Schedule</h2>
                        <p class="text-slate-400">Don't miss new episodes airing this week.</p>
                    </div>
                    
                    <!-- Day Selector -->
                    <div class="flex overflow-x-auto pb-4 gap-3 md:justify-center no-scrollbar snap-x px-4">
                        ${days.map(d => {
                            const timestamp = Math.floor(d.getTime() / 1000);
                            // Check if selected (ignoring time components safely by comparing timestamps roughly or just setting both to midnight which we did)
                            const isSelected = timestamp === selectedTimestamp;
                            const dayName = d.toLocaleDateString('en-US', { weekday: 'short' });
                            const dayNum = d.getDate();
                            const isToday = d.getTime() === today.getTime();
                            
                            return `
                                <button onclick="selectScheduleDay(${timestamp})" class="snap-center flex flex-col items-center justify-center min-w-[4.5rem] h-20 rounded-2xl border transition-all ${isSelected ? 'bg-indigo-600 border-indigo-500 text-white shadow-lg shadow-indigo-500/25 scale-105' : 'bg-slate-800/50 border-slate-700 text-slate-400 hover:bg-slate-800 hover:border-slate-600'}">
                                    <span class="text-xs font-bold uppercase mb-1 ${isSelected ? 'text-indigo-200' : 'text-slate-500'}">${isToday ? 'Today' : dayName}</span>
                                    <span class="text-2xl font-bold">${dayNum}</span>
                                </button>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Schedule List -->
                    <div id="schedule-container" class="max-w-4xl mx-auto min-h-[50vh] space-y-4">
                        ${getLoaderHtml()}
                    </div>
                </div>
                `;
            }
        };

        // -- Core Logic --

        function createAnimeCard(anime, index = 0) {
            const title = anime.title?.english || anime.title?.romaji || 'Unknown Title';
            const image = anime.coverImage?.large || anime.coverImage?.medium;
            const score = anime.averageScore ? Math.round(anime.averageScore) : null;
            const year = anime.seasonYear || anime.startDate?.year || '';
            
            let scoreColor = 'text-slate-400';
            if (score >= 80) scoreColor = 'text-green-400';
            else if (score >= 65) scoreColor = 'text-yellow-400';
            else if (score) scoreColor = 'text-orange-400';

            // Stagger animation based on index
            const staggerClass = index < 8 ? `style="animation-delay: ${index * 50}ms"` : '';

            return `
                <div onclick="openModal(${anime.id})" class="anime-card w-full group relative bg-slate-800 rounded-xl overflow-hidden shadow-lg cursor-pointer hover:shadow-indigo-500/20 fade-in h-full flex flex-col" ${staggerClass}>
                    <div class="aspect-[2/3] overflow-hidden relative flex-shrink-0">
                        <img src="${image}" alt="${title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        
                        <!-- Gradient Overlay -->
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-60 group-hover:opacity-80 transition-opacity"></div>
                        
                        <!-- Hover Overlay Info -->
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                            <span class="bg-indigo-600/90 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm font-bold transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300">View Info</span>
                        </div>

                        <!-- Score Badge -->
                        ${score ? `<div class="absolute top-2 right-2 bg-black/60 backdrop-blur-md text-xs font-bold px-2 py-1 rounded flex items-center gap-1 ${scoreColor}">
                            <svg class="w-3 h-3 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                            ${score}%
                        </div>` : ''}
                    </div>
                    
                    <div class="p-3 flex flex-col flex-grow justify-between">
                        <h4 class="font-semibold text-white text-sm leading-tight line-clamp-2 mb-1 group-hover:text-indigo-400 transition-colors" title="${title}">${title}</h4>
                        <div class="flex justify-between items-center text-xs text-slate-500 mt-auto">
                            <span>${year}</span>
                            <span>${anime.format || 'TV'}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function navigate(page) {
            state.currentPage = page;
            updateActiveNav();
            document.getElementById('app').innerHTML = views[page]();
            window.scrollTo(0, 0);
            
            if (page === 'home') loadHomeData();
            else if (page === 'browse') loadBrowseData();
            else if (page === 'schedule') loadScheduleData();
            else if (page === 'quiz' && state.quiz.currentStep >= 5) fetchQuizResults();
        }

        function scrollCarousel(id, direction) {
            const container = document.getElementById(id);
            if (container) {
                const scrollAmount = container.clientWidth * 0.75;
                container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
            }
        }

        function createCompactAnimeCard(anime) {
            const title = anime.title?.english || anime.title?.romaji || 'Unknown Title';
            const image = anime.coverImage?.large || anime.coverImage?.medium;
            const year = anime.startDate?.year || anime.seasonYear || '';
            const date = anime.startDate ? `${anime.startDate.year}-${String(anime.startDate.month).padStart(2, '0')}` : year;
            
            return `
                <div onclick="openModal(${anime.id})" class="flex-shrink-0 w-48 group relative bg-slate-800 rounded-xl overflow-hidden cursor-pointer hover:shadow-indigo-500/20 transition-all duration-300 hover:-translate-y-2">
                    <div class="aspect-[2/3] overflow-hidden relative">
                        <img src="${image}" alt="${title}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent opacity-80"></div>
                        <div class="absolute bottom-0 left-0 p-3 w-full">
                             <p class="text-indigo-300 text-xs font-bold mb-1">${anime.format || 'TV'}</p>
                             <p class="text-white text-sm font-bold line-clamp-2 leading-tight">${title}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        async function loadHomeData() {
            const trendingContainer = document.getElementById('trending-container');
            const upcomingContainer = document.getElementById('upcoming-container');
            const topRatedContainer = document.getElementById('top-rated-container');
            const popularContainer = document.getElementById('popular-container');

            if (!trendingContainer) return;

            const query = `
                query {
                    Trending: Page(page: 1, perPage: 15) {
                        media(type: ANIME, sort: TRENDING_DESC) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            averageScore
                            seasonYear
                            format
                            startDate { year }
                        }
                    }
                    Upcoming: Page(page: 1, perPage: 10) {
                        media(type: ANIME, sort: POPULARITY_DESC, status: NOT_YET_RELEASED) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            seasonYear
                            format
                            startDate { year month }
                        }
                    }
                    TopRated: Page(page: 1, perPage: 10) {
                        media(type: ANIME, sort: SCORE_DESC) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            seasonYear
                            format
                            startDate { year month }
                        }
                    }
                    Popular: Page(page: 1, perPage: 15) {
                        media(type: ANIME, sort: POPULARITY_DESC) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            averageScore
                            seasonYear
                            format
                            startDate { year }
                        }
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            
            if (data) {
                // Trending
                trendingContainer.innerHTML = data.Trending.media.map((anime, idx) => `
                    <div class="flex-shrink-0 w-48 md:w-56 snap-start">
                        ${createAnimeCard(anime, idx)}
                    </div>
                `).join('');

                // Popular
                popularContainer.innerHTML = data.Popular.media.map((anime, idx) => `
                    <div class="flex-shrink-0 w-48 md:w-56 snap-start">
                        ${createAnimeCard(anime, idx)}
                    </div>
                `).join('');

                // Upcoming (Marquee)
                const upcomingCards = data.Upcoming.media.map(createCompactAnimeCard).join('');
                upcomingContainer.innerHTML = upcomingCards + upcomingCards + upcomingCards;

                // Top Rated (Marquee Reverse)
                const topRatedCards = data.TopRated.media.map(createCompactAnimeCard).join('');
                if (topRatedContainer) {
                    topRatedContainer.innerHTML = topRatedCards + topRatedCards + topRatedCards;
                }
            } else {
                const err = '<p class="col-span-full text-center text-red-400">Failed to load data.</p>';
                if(trendingContainer) trendingContainer.innerHTML = err;
            }
        }

        async function loadBrowseData() {
            const container = document.getElementById('browse-results');
            const indicator = document.getElementById('page-indicator');
            const activeFiltersCount = document.getElementById('active-filters-count');
            
            if (!container) return;
            
            container.innerHTML = getLoaderHtml();
            if (indicator) indicator.textContent = `Page ${state.browse.page}`;
            
            // Count active filters
            const count = [state.browse.genre, state.browse.format, state.browse.status, state.browse.minScore, state.browse.year].filter(v => v).length;
            if(activeFiltersCount) {
                activeFiltersCount.textContent = count;
                activeFiltersCount.classList.toggle('hidden', count === 0);
            }

            let filters = [];
            if (state.browse.search) filters.push(`search: "${state.browse.search}"`);
            if (state.browse.genre) filters.push(`genre_in: ["${state.browse.genre}"]`);
            if (state.browse.format) filters.push(`format: ${state.browse.format}`);
            if (state.browse.status) filters.push(`status: ${state.browse.status}`);
            if (state.browse.minScore) filters.push(`averageScore_greater: ${state.browse.minScore}`);
            if (state.browse.year) filters.push(`seasonYear: ${state.browse.year}`);
            
            const query = `
                query {
                    Page(page: ${state.browse.page}, perPage: 20) {
                        pageInfo { hasNextPage currentPage }
                        media(type: ANIME, sort: ${state.browse.sort} ${filters.length ? ', ' + filters.join(', ') : ''}) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            averageScore
                            seasonYear
                            format
                            startDate { year }
                        }
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            if (data) {
                if (data.Page.media.length > 0) {
                    container.innerHTML = data.Page.media.map((anime, idx) => createAnimeCard(anime, idx)).join('');
                    
                    const prevBtn = document.getElementById('prev-page');
                    const nextBtn = document.getElementById('next-page');
                    if (prevBtn) prevBtn.disabled = state.browse.page <= 1;
                    if (nextBtn) nextBtn.disabled = !data.Page.pageInfo.hasNextPage;
                } else {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12">
                            <div class="text-4xl mb-4">üòî</div>
                            <h3 class="text-xl font-bold text-white mb-2">No results found</h3>
                            <p class="text-slate-400">Try adjusting your filters or search query.</p>
                            <button onclick="clearAllFilters()" class="mt-4 px-6 py-2 bg-indigo-600 rounded-full text-white text-sm font-medium hover:bg-indigo-500 transition">Reset Filters</button>
                        </div>
                    `;
                }
            } else {
                container.innerHTML = '<p class="col-span-full text-center text-red-400">Error loading data.</p>';
            }
        }

        function selectScheduleDay(timestamp) {
            state.schedule.selectedDate = timestamp;
            navigate('schedule');
        }

        async function loadScheduleData() {
            const container = document.getElementById('schedule-container');
            if (!container) return;
            
            container.innerHTML = getLoaderHtml();
            
            const selectedTimestamp = state.schedule.selectedDate || Math.floor(new Date().setHours(0,0,0,0) / 1000);
            const startOfDay = selectedTimestamp;
            const endOfDay = selectedTimestamp + 86400; // + 24 hours
            
            const query = `
                query {
                    Page(page: 1, perPage: 50) {
                        airingSchedules(airingAt_greater: ${startOfDay}, airingAt_lesser: ${endOfDay}, sort: TIME) {
                            id
                            airingAt
                            episode
                            media {
                                id
                                title { romaji english }
                                coverImage { medium large }
                                format
                                averageScore
                                isAdult
                            }
                        }
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            
            if (data && data.Page.airingSchedules.length > 0) {
                // Filter out adult content just in case
                const schedules = data.Page.airingSchedules.filter(s => !s.media.isAdult);
                
                if (schedules.length === 0) {
                     container.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-4xl mb-4">üí§</div>
                            <h3 class="text-xl font-bold text-white">No episodes airing</h3>
                            <p class="text-slate-400 mt-2">Looks like a quiet day for anime releases.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = schedules.map((schedule, idx) => {
                    const date = new Date(schedule.airingAt * 1000);
                    const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    const anime = schedule.media;
                    const title = anime.title.english || anime.title.romaji;
                    
                    return `
                        <div onclick="openModal(${anime.id})" class="group flex items-center gap-4 p-4 bg-slate-800/50 hover:bg-slate-800 rounded-xl border border-slate-700/50 hover:border-indigo-500/50 transition-all cursor-pointer fade-in" style="animation-delay: ${idx * 50}ms">
                            <div class="flex-shrink-0 w-16 text-center">
                                <span class="block text-lg font-bold text-white">${timeString}</span>
                                <span class="block text-xs text-slate-500 font-medium uppercase">Ep ${schedule.episode}</span>
                            </div>
                            
                            <div class="flex-shrink-0 w-16 h-24 relative rounded-lg overflow-hidden shadow-md bg-slate-700">
                                <img src="${anime.coverImage.medium}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500">
                            </div>
                            
                            <div class="flex-grow min-w-0">
                                <h4 class="text-white font-bold text-lg truncate group-hover:text-indigo-400 transition-colors">${title}</h4>
                                <div class="flex items-center gap-3 text-sm text-slate-400 mt-1">
                                    <span>${anime.format}</span>
                                    ${anime.averageScore ? `<span class="flex items-center gap-1 text-green-400"><svg class="w-3 h-3 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>${anime.averageScore}%</span>` : ''}
                                </div>
                            </div>
                            
                             <div class="flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity -translate-x-2 group-hover:translate-x-0 transform duration-300 hidden sm:block">
                                <svg class="w-6 h-6 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-4xl mb-4">üí§</div>
                        <h3 class="text-xl font-bold text-white">No episodes airing</h3>
                        <p class="text-slate-400 mt-2">Looks like a quiet day for anime releases.</p>
                    </div>
                `;
            }
        }

        // -- Event Handlers --

        let searchTimeout;
        function debounceSearch(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                state.browse.search = e.target.value;
                state.browse.page = 1;
                loadBrowseData();
            }, 600);
        }

        function clearSearch() {
            state.browse.search = '';
            const input = document.getElementById('search-input');
            if(input) input.value = '';
            state.browse.page = 1;
            loadBrowseData();
        }

        function toggleFilters() {
            const panel = document.getElementById('advanced-filters');
            panel.classList.toggle('hidden');
        }

        function handleFilterChange() {
            state.browse.genre = document.getElementById('genre-filter')?.value || '';
            state.browse.format = document.getElementById('format-filter')?.value || '';
            state.browse.status = document.getElementById('status-filter')?.value || '';
            state.browse.minScore = document.getElementById('score-filter')?.value || '';
            state.browse.year = document.getElementById('year-filter')?.value || '';
            state.browse.page = 1;
            loadBrowseData();
        }

        function clearAllFilters() {
            state.browse = { ...state.browse, page: 1, search: '', genre: '', format: '', status: '', minScore: '', year: '', sort: 'POPULARITY_DESC' };
            
            // Reset UI elements
            const ids = ['search-input', 'genre-filter', 'format-filter', 'status-filter', 'score-filter', 'year-filter'];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            
            loadBrowseData();
        }

        function setSortOption(sort) {
            state.browse.sort = sort;
            state.browse.page = 1;
            loadBrowseData();
        }

        function changePage(delta) {
            state.browse.page += delta;
            if (state.browse.page < 1) state.browse.page = 1;
            loadBrowseData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function handleQuizAnswer(value) {
            state.quiz.answers.push(value);
            state.quiz.currentStep++;
            navigate('quiz');
        }

        function resetQuiz() {
            state.quiz = { currentStep: 0, answers: [] };
            navigate('quiz');
        }

        async function fetchQuizResults() {
            const container = document.getElementById('quiz-results');
            if (!container) return;
            
            // Extract logic
            const genre = state.quiz.answers.find(a => state.genres.includes(a));
            const formatAnswer = state.quiz.answers[3];
            const formatFilter = (formatAnswer && formatAnswer !== 'any') ? `format: ${formatAnswer}` : '';
            
            const query = `
                query {
                    Page(page: 1, perPage: 12) {
                        media(type: ANIME, sort: SCORE_DESC, averageScore_greater: 70 ${genre ? `, genre_in: ["${genre}"]` : ''} ${formatFilter ? `, ${formatFilter}` : ''}) {
                            id
                            title { romaji english }
                            coverImage { large medium }
                            averageScore
                            seasonYear
                            format
                            startDate { year }
                        }
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            if (data) {
                // Simple randomization
                const shuffled = data.Page.media.sort(() => 0.5 - Math.random()).slice(0, 4);
                container.innerHTML = shuffled.map((anime, idx) => createAnimeCard(anime, idx)).join('');
            } else {
                container.innerHTML = '<p class="col-span-full text-center text-red-400">Could not calculate results.</p>';
            }
        }

        function toggleMobileMenu() {
            document.getElementById('mobile-menu').classList.toggle('hidden');
        }

        // -- Modal Logic --

        let currentAnimeCharacters = [];

        async function openModal(id) {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            overlay.classList.remove('hidden', 'opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
            
            // Skeleton Loading State for Modal
            content.innerHTML = `
                <div class="h-64 bg-slate-800 animate-pulse rounded-t-2xl"></div>
                <div class="p-8">
                    <div class="h-8 w-1/2 bg-slate-800 animate-pulse rounded mb-4"></div>
                    <div class="h-4 w-1/3 bg-slate-800 animate-pulse rounded mb-8"></div>
                    <div class="space-y-2">
                        <div class="h-4 w-full bg-slate-800 animate-pulse rounded"></div>
                        <div class="h-4 w-full bg-slate-800 animate-pulse rounded"></div>
                        <div class="h-4 w-2/3 bg-slate-800 animate-pulse rounded"></div>
                    </div>
                </div>
            `;
            
            const query = `
                query {
                    Media(id: ${id}) {
                        id
                        title { romaji english native }
                        coverImage { extraLarge large }
                        bannerImage
                        description
                        episodes
                        duration
                        status
                        season
                        seasonYear
                        averageScore
                        popularity
                        favourites
                        genres
                        format
                        source
                        studios { nodes { name } }
                        trailer { id site }
                        relations {
                            edges {
                                relationType
                                node {
                                    id
                                    title { romaji english }
                                    coverImage { medium }
                                    format
                                    averageScore
                                }
                            }
                        }
                        characters(perPage: 8, sort: ROLE) {
                            edges {
                                role
                                node {
                                    id
                                    name { full }
                                    image { large }
                                }
                                voiceActors(language: JAPANESE) {
                                    name { full }
                                }
                            }
                        }
                        recommendations(perPage: 6, sort: RATING_DESC) {
                            nodes {
                                mediaRecommendation {
                                    id
                                    title { romaji english }
                                    coverImage { large }
                                }
                            }
                        }
                        siteUrl
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            if (!data) {
                content.innerHTML = '<div class="p-8 text-center text-red-400">Failed to load anime details.</div>';
                return;
            }
            
            const anime = data.Media;
            currentAnimeCharacters = anime.characters?.edges || [];
            
            // Data processing
            const title = anime.title.english || anime.title.romaji;
            const banner = anime.bannerImage || anime.coverImage.extraLarge;
            const desc = anime.description || 'No description available.';
            const trailerUrl = (anime.trailer?.site === 'youtube' && anime.trailer?.id) ? `https://www.youtube.com/embed/${anime.trailer.id}` : null;
            
            const studios = anime.studios?.nodes?.map(s => s.name).join(', ') || 'Unknown';
            const relatedContent = anime.relations?.edges?.filter(edge => ['PREQUEL', 'SEQUEL'].includes(edge.relationType)) || [];
            
            // Render content
            content.innerHTML = `
                <div class="relative">
                    <!-- Close Button -->
                    <button onclick="closeModal()" class="absolute top-4 right-4 z-10 p-2 bg-black/50 hover:bg-red-500 backdrop-blur-md text-white rounded-full transition-all">
                        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    
                    <!-- Banner Header -->
                    <div class="h-56 md:h-80 w-full relative">
                        <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${banner}');"></div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/60 to-transparent"></div>
                        
                        <div class="absolute bottom-0 left-0 w-full p-6 md:p-10 flex items-end gap-6">
                            <!-- Poster (Desktop) -->
                            <img src="${anime.coverImage.extraLarge}" class="hidden md:block w-48 rounded-xl shadow-2xl border-4 border-slate-800 -mb-16 z-20 bg-slate-800">
                            
                            <div class="flex-1 mb-2">
                                <h2 class="text-3xl md:text-5xl font-bold text-white leading-tight text-shadow-lg">${title}</h2>
                                <p class="text-slate-300 text-lg">${anime.title.native || ''}</p>
                                <div class="flex flex-wrap gap-2 mt-3">
                                    ${anime.genres.map(g => `<span class="px-3 py-1 bg-indigo-600/80 backdrop-blur-sm rounded-full text-xs font-bold text-white border border-indigo-500/30">${g}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Left Column (Info) -->
                        <div class="md:col-span-1 space-y-6">
                            <!-- Mobile Poster -->
                            <img src="${anime.coverImage.extraLarge}" class="md:hidden w-48 mx-auto rounded-xl shadow-2xl border-4 border-slate-800 mb-6">
                            
                            <div class="bg-slate-800/50 rounded-xl p-5 border border-slate-700/50 space-y-4">
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="p-3 bg-slate-700/50 rounded-lg">
                                        <div class="text-green-400 font-bold text-xl">${anime.averageScore || 'N/A'}%</div>
                                        <div class="text-xs text-slate-400 uppercase">Score</div>
                                    </div>
                                    <div class="p-3 bg-slate-700/50 rounded-lg">
                                        <div class="text-indigo-400 font-bold text-xl">#${anime.popularity?.toLocaleString() || '-'}</div>
                                        <div class="text-xs text-slate-400 uppercase">Popularity</div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between border-b border-slate-700 pb-2">
                                        <span class="text-slate-400">Format</span>
                                        <span class="font-medium">${anime.format}</span>
                                    </div>
                                    <div class="flex justify-between border-b border-slate-700 pb-2">
                                        <span class="text-slate-400">Episodes</span>
                                        <span class="font-medium">${anime.episodes || '?'}</span>
                                    </div>
                                    <div class="flex justify-between border-b border-slate-700 pb-2">
                                        <span class="text-slate-400">Status</span>
                                        <span class="font-medium">${anime.status}</span>
                                    </div>
                                    <div class="flex justify-between border-b border-slate-700 pb-2">
                                        <span class="text-slate-400">Season</span>
                                        <span class="font-medium capitalize">${(anime.season || '').toLowerCase()} ${anime.seasonYear || ''}</span>
                                    </div>
                                    <div class="flex justify-between border-b border-slate-700 pb-2">
                                        <span class="text-slate-400">Studio</span>
                                        <span class="font-medium text-right truncate w-32">${studios}</span>
                                    </div>
                                </div>
                                
                                <a href="${anime.siteUrl}" target="_blank" class="block w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-center rounded-lg font-bold text-white transition shadow-lg shadow-indigo-500/20">
                                    View on AniList
                                </a>
                            </div>
                        </div>
                        
                        <!-- Right Column (Content) -->
                        <div class="md:col-span-2 space-y-8">
                            <div class="prose prose-invert max-w-none">
                                <h3 class="text-xl font-bold text-white mb-2">Synopsis</h3>
                                <div class="text-slate-300 leading-relaxed bg-slate-800/30 p-4 rounded-xl border border-slate-700/50">
                                    ${desc}
                                </div>
                            </div>
                            
                            ${trailerUrl ? `
                                <div>
                                    <h3 class="text-xl font-bold text-white mb-3">Trailer</h3>
                                    <div class="aspect-video rounded-xl overflow-hidden shadow-lg">
                                        <iframe src="${trailerUrl}" class="w-full h-full" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div>
                                <h3 class="text-xl font-bold text-white mb-3">Main Characters</h3>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    ${currentAnimeCharacters.slice(0, 8).map((edge, idx) => `
                                        <div onclick="openCharacterModal(${idx})" class="bg-slate-800 rounded-lg overflow-hidden hover:bg-slate-700 cursor-pointer transition group">
                                            <div class="aspect-square overflow-hidden">
                                                <img src="${edge.node.image.large}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                                            </div>
                                            <div class="p-2">
                                                <div class="font-bold text-sm truncate text-white">${edge.node.name.full}</div>
                                                <div class="text-xs text-slate-400 truncate">${edge.role}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                             ${relatedContent.length > 0 ? `
                                <div>
                                    <h3 class="text-xl font-bold text-white mb-3">Franchise</h3>
                                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-3 mb-8">
                                        ${relatedContent.map(edge => `
                                            <div onclick="openModal(${edge.node.id})" class="cursor-pointer group">
                                                <div class="aspect-[2/3] rounded-lg overflow-hidden shadow-md relative">
                                                    <img src="${edge.node.coverImage.medium}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                                                    <div class="absolute top-0 left-0 bg-indigo-600/90 text-white text-[10px] font-bold px-2 py-1 rounded-br-lg">
                                                        ${edge.relationType === 'PREQUEL' ? 'Prequel' : 'Sequel'}
                                                    </div>
                                                </div>
                                                <div class="mt-1 text-xs font-medium text-slate-400 truncate group-hover:text-white transition-colors">${edge.node.title.english || edge.node.title.romaji}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}

                             ${anime.recommendations?.nodes?.length ? `
                                <div>
                                    <h3 class="text-xl font-bold text-white mb-3">You Might Also Like</h3>
                                    <div class="grid grid-cols-3 sm:grid-cols-6 gap-3">
                                        ${anime.recommendations.nodes.filter(r => r.mediaRecommendation).map(rec => `
                                            <div onclick="openModal(${rec.mediaRecommendation.id})" class="cursor-pointer group">
                                                <div class="aspect-[2/3] rounded-lg overflow-hidden shadow-md relative">
                                                    <img src="${rec.mediaRecommendation.coverImage.large}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110">
                                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors"></div>
                                                </div>
                                                <div class="mt-1 text-xs font-medium text-slate-400 truncate group-hover:text-white transition-colors">${rec.mediaRecommendation.title.english || rec.mediaRecommendation.title.romaji}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            
            overlay.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                content.innerHTML = '';
            }, 300);
        }
        
        document.getElementById('modal-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'modal-overlay') closeModal();
        });

        async function openCharacterModal(index) {
            const charEdge = currentAnimeCharacters[index];
            if (!charEdge) return;
            
            // Fetch more details
            const query = `
                query {
                    Character(id: ${charEdge.node.id}) {
                        id
                        name { full native }
                        image { large }
                        description
                        age
                        gender
                        bloodType
                        dateOfBirth { year month day }
                        siteUrl
                    }
                }
            `;
            
            const data = await anilistQuery(query);
            if (!data) return;
            
            const char = data.Character;
            const overlay = document.getElementById('character-modal-overlay');
            
            overlay.innerHTML = `
                <div class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[60] flex items-center justify-center p-4 animate-fadeIn">
                    <div class="bg-slate-800 rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto border border-slate-600 shadow-2xl flex flex-col md:flex-row overflow-hidden">
                        <div class="w-full md:w-1/3 bg-slate-700/30 relative">
                            <img src="${char.image.large}" class="w-full h-64 md:h-full object-cover">
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 md:bg-gradient-to-r md:from-transparent md:to-slate-800/80"></div>
                        </div>
                        <div class="w-full md:w-2/3 p-6 relative">
                            <button onclick="document.getElementById('character-modal-overlay').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-700/50 rounded-full p-1">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                            
                            <h2 class="text-3xl font-bold text-white mb-1">${char.name.full}</h2>
                            <p class="text-slate-400 text-sm mb-4">${char.name.native || ''}</p>
                            
                            <div class="flex flex-wrap gap-3 mb-6 text-xs">
                                ${char.age ? `<span class="px-2 py-1 bg-slate-700 rounded text-slate-200">Age: ${char.age}</span>` : ''}
                                ${char.gender ? `<span class="px-2 py-1 bg-slate-700 rounded text-slate-200">Gender: ${char.gender}</span>` : ''}
                                ${char.bloodType ? `<span class="px-2 py-1 bg-slate-700 rounded text-slate-200">Blood: ${char.bloodType}</span>` : ''}
                            </div>
                            
                            <div class="prose prose-invert prose-sm max-h-60 overflow-y-auto pr-2 scrollbar-thin">
                                ${char.description || 'No description.'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            overlay.classList.remove('hidden');
        }

        // -- Surprise Me Logic --
        
        function openSurpriseSettings() {
            const overlay = document.getElementById('surprise-settings-overlay');
            const content = document.getElementById('surprise-settings-content');
            
            content.innerHTML = `
                <div class="p-6 bg-slate-900">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400">Randomizer Settings</h2>
                        <button onclick="closeSurpriseSettings()" class="text-slate-400 hover:text-white"><svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase">Genre</label>
                            <select id="surprise-genre" class="w-full bg-slate-800 border border-slate-700 rounded-lg p-3 text-sm focus:ring-indigo-500 focus:border-indigo-500 text-white">
                                <option value="">Any Genre</option>
                                ${state.genres.map(g => `<option value="${g}" ${state.surprise.genre === g ? 'selected' : ''}>${g}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-400 mb-2 uppercase">Minimum Score</label>
                            <div class="flex gap-2">
                                ${['', '60', '70', '80'].map(s => `
                                    <button onclick="updateSurpriseScore('${s}')" class="flex-1 py-2 rounded-lg text-sm border ${state.surprise.minScore === s ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-slate-800 border-slate-700 text-slate-400 hover:border-slate-500'} transition">${s ? s + '+' : 'Any'}</button>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8">
                        <button onclick="saveSurpriseSettings()" class="w-full py-3 bg-gradient-to-r from-indigo-600 to-pink-600 hover:from-indigo-500 hover:to-pink-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/20 transition-all transform active:scale-95">
                            Save & Close
                        </button>
                    </div>
                </div>
            `;
            
            overlay.classList.remove('hidden', 'opacity-0');
            content.classList.remove('scale-95');
            content.classList.add('scale-100');
        }

        function updateSurpriseScore(val) {
            state.surprise.minScore = val;
            openSurpriseSettings(); // Re-render to update UI state
        }

        function closeSurpriseSettings() {
             const overlay = document.getElementById('surprise-settings-overlay');
             const content = document.getElementById('surprise-settings-content');
             overlay.classList.add('opacity-0');
             content.classList.add('scale-95');
             setTimeout(() => overlay.classList.add('hidden'), 300);
        }

        function saveSurpriseSettings() {
            const genreEl = document.getElementById('surprise-genre');
            if (genreEl) state.surprise.genre = genreEl.value;
            closeSurpriseSettings();
        }

        async function surpriseMe() {
            const btn = document.querySelector('button[onclick="surpriseMe()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loader w-4 h-4 border-2"></span> Rolling...';
            
            try {
                let filters = [];
                if (state.surprise.genre) filters.push(`genre_in: ["${state.surprise.genre}"]`);
                if (state.surprise.minScore) filters.push(`averageScore_greater: ${state.surprise.minScore}`);
                
                // Random page to ensure variety
                const randomPage = Math.floor(Math.random() * 10) + 1;
                
                const query = `
                    query {
                        Page(page: ${randomPage}, perPage: 50) {
                            media(type: ANIME, sort: POPULARITY_DESC ${filters.length ? ', ' + filters.join(', ') : ''}) {
                                id
                            }
                        }
                    }
                `;
                
                const data = await anilistQuery(query);
                if (data && data.Page.media.length > 0) {
                    const randomAnime = data.Page.media[Math.floor(Math.random() * data.Page.media.length)];
                    openModal(randomAnime.id);
                } else {
                    alert('No anime found with current settings!');
                }
            } catch (e) {
                console.error(e);
            } finally {
                btn.innerHTML = originalText;
            }
        }

        document.getElementById('surprise-settings-overlay').addEventListener('click', (e) => {
            if (e.target.id === 'surprise-settings-overlay') closeSurpriseSettings();
        });

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            init();
        });

        function init() {
            navigate('home');
            
            // Add simple intro animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
                .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>